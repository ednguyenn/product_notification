
# Build stage
FROM amazon/aws-lambda-python:3.9 AS builder

# Install Chrome and its dependencies
RUN dnf install -y atk cups-libs gtk3 libXcomposite alsa-lib \
    libXcursor libXdamage libXext libXi libXrandr libXScrnSaver \
    libXtst pango at-spi2-atk libXt xorg-x11-server-Xvfb \
    xorg-x11-xauth dbus-glib dbus-glib-devel nss mesa-libgbm jq unzip

# Copy and run the Chrome installation script
COPY chrome-installer.sh .
RUN chmod +x ./chrome-installer.sh && ./chrome-installer.sh && rm ./chrome-installer.sh

# Install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Final stage
FROM amazon/aws-lambda-python:3.9

# Copy Chrome and dependencies from builder
COPY --from=builder /opt/chrome /opt/chrome
COPY --from=builder /opt/chrome-driver /opt/chrome-driver

# Copy Python dependencies
COPY --from=builder /var/lang /var/lang

# Copy application code
COPY . .

# Set the entrypoint and command
ENTRYPOINT [ "/var/lang/bin/python", "-m", "awslambdaric" ]
CMD [ "app.lambda_handler" ]


